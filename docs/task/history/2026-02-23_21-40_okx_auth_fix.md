# OKX API 身份验证修复工作纪实 (2026-02-23)

## 问题描述

在运行 `run_live_grid.py` 时，系统在执行 `get_balance` 和 `get_positions` 时触发了 `401 Unauthorized` 错误。

## 修复措施

### [okx_config.py](file:///c:/Projects/CTS1/okx_config.py)

1.  **GET 请求签名修复**：
    *   OKX API 要求签名的请求路径必须包含查询参数（即 `?ccy=USDT` 部分）。
    *   原有代码仅使用了 `/api/v5/account/balance` 进行签名，导致验证失败。
    *   **修复**：在 `_request` 方法中，如果是 GET 请求则将 `params` URL 编码后拼接到 `request_path` 中参与签名。

2.  **POST 请求 Body 统一**：
    *   OKX API 签名必须与实际发送的 Body 字符串完全一致（包括空格和字符顺序）。
    *   **修复**：在 `_request` 中先将 Body 序列化为 `body_str`，同时用于签名和 `requests` 的 `data` 发送，确保万无一失。

## 验证结果

运行了 `test_okx_fix.py` 进行验证：

-   **余额查询**：成功返回模拟盘余额 `3000.0 USDT`。
-   **持仓查询**：成功返回持仓列表（当前为空）。
-   **下单验证**：成功通过身份认证。虽然因数量不满足 OKX 最小限制报业务错误（51020），但已排除 `401` 错误（若签名错误，OKX 会直接返回 401，不会执行下一步业务检查）。

## 资产状态同步

目前 `run_live_grid.py` 每 5 个 tick 自动同步一次 OKX 云端资产，当前状态已可正常同步。

---
完成时间：2026-02-23 21:40
归档文件：[2026-02-23_21-40_okx_auth_fix.md](file:///c:/Projects/CTS1/docs/task/history/2026-02-23_21-40_okx_auth_fix.md)
